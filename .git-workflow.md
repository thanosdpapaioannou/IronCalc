# IronCalc Fork Workflow

## Overview
This repository is a fork of the upstream IronCalc project with our custom modifications.
We maintain our changes in a fork to easily sync with upstream updates while preserving our customizations.

## Repository Structure

### Remotes
- **origin**: Our fork at https://github.com/thanosdpapaioannou/IronCalc.git
- **upstream**: Original IronCalc at https://github.com/ironcalc/IronCalc.git

### Branches
- **main**: Synced with upstream main branch
- **our-customizations**: Contains all our custom changes (csv-rs, etc.)
- **backup-csv-rs-changes**: Backup of our csv-rs implementation

## Custom Changes
Our fork includes:
1. **CSV-RS Implementation**: RFC 4180 compliant CSV parsing
   - Added csv = "1.3" dependency
   - Handles quoted fields with commas (e.g., "124 4th Ave, Apt 2")
   - Supports escaped quotes and multi-line fields
2. **React PeerDependencies**: Fixed React hooks errors in webapp

## Common Workflows

### 1. Sync with Upstream (Get Latest IronCalc Updates)
```bash
# Fetch latest changes from upstream
git fetch upstream

# Switch to main branch
git checkout main

# Merge upstream changes
git merge upstream/main

# Push to our fork
git push origin main

# Rebase our customizations on top of new changes
git checkout our-customizations
git rebase main

# If conflicts occur, resolve them then:
git rebase --continue

# Force push updated branch (safe since it's our fork)
git push origin our-customizations --force
```

### 2. Add New Customizations
```bash
# Always work on our-customizations branch
git checkout our-customizations

# Make your changes
# ... edit files ...

# Commit changes
git add .
git commit -m "feat: Description of new customization"

# Push to fork
git push origin our-customizations
```

### 3. Build WASM with Our Changes
```bash
cd bindings/wasm
wasm-pack build --target web

# Copy to frontend projects
cp pkg/wasm_bg.wasm /Users/tdp/dev/basic-notions-sheet/frontend/public/
cp pkg/wasm.js pkg/wasm_bg.wasm /Users/tdp/dev/IronCalc/webapp/IronCalc/dist/
```

### 4. Emergency Recovery
If something goes wrong, we have backups:
```bash
# Restore from backup branch
git checkout backup-csv-rs-changes

# Or fetch from our fork
git fetch origin
git reset --hard origin/our-customizations
```

## Important Notes

### When to Sync with Upstream
- Before starting new development
- When upstream announces bug fixes or new features
- Periodically (e.g., monthly) to avoid drift

### Conflict Resolution Strategy
When rebasing our-customizations after upstream sync:
1. Our changes take precedence for csv-rs implementation
2. Accept upstream changes for everything else
3. Test thoroughly after rebasing

### Testing After Updates
Always test after syncing:
```bash
# Build WASM
cd bindings/wasm
wasm-pack build --target web

# Test in frontend
cd /Users/tdp/dev/basic-notions-sheet/frontend
npm start
# Click on Excel files to test csv parsing
```

## Troubleshooting

### Push Rejected
If push is rejected after rebase:
```bash
git push origin our-customizations --force
```
This is safe since we own the fork.

### Lost Changes
Check backup branch:
```bash
git checkout backup-csv-rs-changes
git log --oneline
```

### Merge Conflicts in package.json
Usually keep our peerDependencies changes:
```bash
git checkout --ours webapp/IronCalc/package.json
```

## Contributing Upstream
If we want to contribute our csv-rs implementation upstream:
1. Create a clean feature branch from upstream/main
2. Cherry-pick only the csv-rs commits
3. Create PR to upstream repository